
rm(list = ls())

library(readxl)

setwd("I:/PublicHealth/ChrisPaul/TIPS-main-analysis/Programs/R")


f.name <- "../../Data/Original/TIPS numerator data_Tipsall_05 10 2016 at 12 20pm.xlsx"
df1 <- readxl::read_excel(f.name, 
                            sheet = "2011-2015 only data")


df1$biStrokeDateTime <- lubridate::as_datetime(df1$biStrokeDateTime)
summary(df1$biStrokeDateTime)

df1$biArrivalDateTime <- lubridate::as_datetime(df1$biArrivalDateTime)
summary(df1$biArrivalDateTime)

df1$biBrainImagingDateTime <- lubridate::as_datetime(df1$biBrainImagingDateTime)
summary(df1$biBrainImagingDateTime)

df1$biRtPaDateTime <- lubridate::as_datetime(df1$biRtPaDateTime)
summary(df1$biRtPaDateTime)



df1$biRtPaDateTime - df1$biArrivalDateTime



tmp <- data.frame(id = df1$PatientId,
                  arrival = df1$biArrivalDateTime, 
                  tpa = df1$biRtPaDateTime)
tmp$ttn.hrs <- as.numeric(difftime(tmp$tpa,tmp$arrival,units="hours"))

psych::describe(tmp$ttn.hrs)

tmp[which(tmp$ttn.hrs < 0),]
tmp[which(is.na(tmp$ttn.hrs)),]

tmp$censor <- ifelse(is.na(tmp$ttn.hrs), 0, 1)

library(dplyr)
tmp <- tmp %>% 
  dplyr::filter(ttn.hrs >= 0 | is.na(ttn.hrs)) 
  


library(survival)

s1 <- survfit(Surv(as.numeric(ttn.hrs), event = censor, type = "right")~1, 
              data = tmp, conf.type = "log-log")



library(ggplot2)
library(ggfortify)
p <- ggplot2::autoplot(s1, censor.colour = 'black',
                       conf.int = F, main = "Time to needle")
p <- p + theme_bw()
p <- p + xlab("Hours")
p <- p + ylab("Survival probability")
#p <- p + theme(legend.position="none")
# p <- p + theme(legend.position=c(.75, .75),
#                text = element_text(size=10),
#                legend.title=element_blank(),
#                legend.key.size = unit(0.7, "cm"),
#                legend.key = element_rect(colour = "transparent", fill = "white"), 
#                legend.background = element_rect(fill=alpha('white', 0.01)))
#p <- p + scale_x_continuous(breaks = times)
p








